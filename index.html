<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="utf-8">
  <title>Match Stats, Momentum, Possession & Tactical Heatmap</title>
  <!-- ApexCharts from CDN -->
  <script src="https://cdn.jsdelivr.net/npm/apexcharts"></script>
  <!-- Inter font -->
  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;700&display=swap" rel="stylesheet">

  <style>
    /* Basic layout preventing scrollbars and ensuring full viewport usage */
    html, body {
      margin: 0;
      padding: 0;
      width: 100vw;
      height: 100vh;
      font-family: "Inter", sans-serif;
      background: #f8f8f8;
      text-align: center;
      overflow: hidden; /* Minimizes scrollbars in an embed scenario */
      display: flex;
      flex-direction: column;
      align-items: center;
    }

    /* Each chart container is a flexible box with some padding & a card-like style */
    .chart-container {
      width: 90vw;
      max-width: 900px;
      background: #fff;
      border-radius: 8px;
      padding: 2vh;
      box-shadow: 0 1px 4px rgba(0,0,0,0.1);
      display: flex;
      justify-content: center;
      align-items: center;
      margin-bottom: 2vh;
    }

    /*
      We'll define recommended heights for each chart.
      Adjust these as needed for your embed scenario.
    */
    #statsChart {
      width: 100%;
      height: 40vh;
      min-height: 320px; /* Large bar chart for stats */
    }
    #momentumChart {
      width: 100%;
      height: 30vh;
      min-height: 280px; /* Momentum line chart */
    }
    #possessionChart {
      width: 80vw;          /* Donut chart can be narrower */
      max-width: 400px;
      height: 30vh;
      min-height: 280px;
    }
    #zoneHeatmap {
      width: 100%;
      height: 40vh;
      min-height: 320px; /* Tactical heatmap (attack vs. defense) */
    }
  </style>
</head>
<body>

  <!-- 1) Stats Chart -->
  <div class="chart-container">
    <div id="statsChart"></div>
  </div>

  <!-- 2) Momentum Chart -->
  <div class="chart-container">
    <div id="momentumChart"></div>
  </div>

  <!-- 3) Ball Possession Chart -->
  <div class="chart-container">
    <div id="possessionChart"></div>
  </div>

  <!-- 4) Tactical Heatmap -->
  <div class="chart-container">
    <div id="zoneHeatmap"></div>
  </div>

  <script>
    /*************************************************************
     * GLOBAL COLORS
     *************************************************************/
    const HOME_COLOR = "#fa3048";  // Red for Home
    const AWAY_COLOR = "#2c2c2c";  // Dark Gray (or use Blue if you prefer)

    /*************************************************************
     * PARSE URL PARAMS (NO PLACEHOLDERS)
     *************************************************************/
    const params = new URLSearchParams(window.location.search);

    /* 1) Stats Chart Data:
       Shots, Shots on Goal, Goal Chances, Duels Won,
       Saves, Corners, Fouls, Yellows, Reds
       "home_shots", "away_shots", etc.
    */
    const homeStats = [
      Number(params.get("home_shots")              || 0),
      Number(params.get("home_shots_on_goal")      || 0),
      Number(params.get("home_goal_chances")       || 0),
      Number(params.get("home_duels_won")          || 0),
      Number(params.get("home_saves")              || 0),
      Number(params.get("home_corners")            || 0),
      Number(params.get("home_fouls")              || 0),
      Number(params.get("home_yellows")            || 0),
      Number(params.get("home_reds")               || 0)
    ];
    const awayStats = [
      Number(params.get("away_shots")              || 0),
      Number(params.get("away_shots_on_goal")      || 0),
      Number(params.get("away_goal_chances")       || 0),
      Number(params.get("away_duels_won")          || 0),
      Number(params.get("away_saves")              || 0),
      Number(params.get("away_corners")            || 0),
      Number(params.get("away_fouls")              || 0),
      Number(params.get("away_yellows")            || 0),
      Number(params.get("away_reds")               || 0)
    ];
    const statLabels = [
      "Shots", "Shots on Goal", "Goal Chances", "Duels Won",
      "Saves", "Corners", "Fouls", "Yellows", "Reds"
    ];

    /* 2) Momentum Data Over Time:
       "time_tracker" => array of minutes
       "momentum_tracker" => array of home momentum (0..1)
       away = 1 - home
    */
    const rawTimeTracker = params.get("time_tracker")     || "0,15,30,45,60,75,90";
    const rawMomentum    = params.get("momentum_tracker") || "0.5,0.55,0.6,0.55,0.4,0.7,0.6";
    const timeData          = rawTimeTracker.split(",").map(x => Number(x.trim()));
    const homeMomentumData  = rawMomentum.split(",").map(x => Number(x.trim()));
    const awayMomentumData  = homeMomentumData.map(v => 1 - v);

    /* 3) Ball Possession:
       "possessionHome", "possessionAway"
    */
    const possessionHome = Number(params.get("possessionHome") || 50);
    const possessionAway = Number(params.get("possessionAway") || 50);

    /* 4) Tactical Heatmap (Attack vs. Defense Ratios)
       We have 32 columns:
       home_attack_initial_buildup, home_defend_initial_buildup, away_attack_initial_buildup, away_defend_initial_buildup, ...
       We'll define 2 series:
         "HomeAtt vs AwayDef"
         "HomeDef vs AwayAtt"
       Each with 8 zone data points (buildup init/final, midfield init/final, wing init/final, lastthird init/final).
       We'll compute ratio = home_attack / (home_attack + away_defend) for the first series, etc.
    */

    // Retrieve relevant values ( or 0 if missing ):
    function val(name) { return Number(params.get(name) || 0); }

    // For each zone pair, compute ratio for "HomeAtt vs AwayDef" and "HomeDef vs AwayAtt"
    // ratio = home_attack / (home_attack + away_defend)
    //        home_defend / (home_defend + away_attack)
    // zoneCategories => e.g. Buildup(Init), Buildup(Final), Midfield(Init), ...
    const zoneCategories = [
      "Buildup (Initial)",
      "Buildup (Final)",
      "Midfield (Initial)",
      "Midfield (Final)",
      "Wingplay (Initial)",
      "Wingplay (Final)",
      "LastThird (Initial)",
      "LastThird (Final)"
    ];

    function ratio(homeVal, awayVal) {
      const sum = homeVal + awayVal;
      return sum > 0 ? homeVal / sum : 0.5; // fallback ratio
    }

    // Calculate data for "HomeAtt vs AwayDef"
    const homeAttAwayDefData = [
      // Buildup(Init):
      { x: zoneCategories[0],
        y: ratio(val("home_attack_initial_buildup"), val("away_defend_initial_buildup")) },
      // Buildup(Final):
      { x: zoneCategories[1],
        y: ratio(val("home_attack_final_buildup"), val("away_defend_final_buildup")) },
      // Midfield(Init):
      { x: zoneCategories[2],
        y: ratio(val("home_attack_initial_midfield"), val("away_defend_initial_midfield")) },
      // Midfield(Final):
      { x: zoneCategories[3],
        y: ratio(val("home_attack_final_midfield"), val("away_defend_final_midfield")) },
      // Wing(Init):
      { x: zoneCategories[4],
        y: ratio(val("home_attack_initial_wingplay"), val("away_defend_initial_wingplay")) },
      // Wing(Final):
      { x: zoneCategories[5],
        y: ratio(val("home_attack_final_wingplay"), val("away_defend_final_wingplay")) },
      // LastThird(Init):
      { x: zoneCategories[6],
        y: ratio(val("home_attack_initial_lastthird"), val("away_defend_initial_lastthird")) },
      // LastThird(Final):
      { x: zoneCategories[7],
        y: ratio(val("home_attack_final_lastthird"), val("away_defend_final_lastthird")) }
    ];

    // Calculate data for "HomeDef vs AwayAtt"
    const homeDefAwayAttData = [
      // Buildup(Init):
      { x: zoneCategories[0],
        y: ratio(val("home_defend_initial_buildup"), val("away_attack_initial_buildup")) },
      // Buildup(Final):
      { x: zoneCategories[1],
        y: ratio(val("home_defend_final_buildup"), val("away_attack_final_buildup")) },
      // Midfield(Init):
      { x: zoneCategories[2],
        y: ratio(val("home_defend_initial_midfield"), val("away_attack_initial_midfield")) },
      // Midfield(Final):
      { x: zoneCategories[3],
        y: ratio(val("home_defend_final_midfield"), val("away_attack_final_midfield")) },
      // Wing(Init):
      { x: zoneCategories[4],
        y: ratio(val("home_defend_initial_wingplay"), val("away_attack_initial_wingplay")) },
      // Wing(Final):
      { x: zoneCategories[5],
        y: ratio(val("home_defend_final_wingplay"), val("away_attack_final_wingplay")) },
      // LastThird(Init):
      { x: zoneCategories[6],
        y: ratio(val("home_defend_initial_lastthird"), val("away_attack_initial_lastthird")) },
      // LastThird(Final):
      { x: zoneCategories[7],
        y: ratio(val("home_defend_final_lastthird"), val("away_attack_final_lastthird")) }
    ];

    const zoneHeatmapSeries = [
      { name: "HomeAtt vs AwayDef", data: homeAttAwayDefData },
      { name: "HomeDef vs AwayAtt", data: homeDefAwayAttData },
    ];

    /*************************************************************
     * 1) STATS CHART (Horizontal Bars)
     *************************************************************/
    new ApexCharts(document.querySelector("#statsChart"), {
      chart: {
        type: "bar",
        height: "100%",
        width: "100%"
      },
      series: [
        { name: "Home", data: homeStats },
        { name: "Away", data: awayStats }
      ],
      xaxis: { categories: statLabels },
      colors: [HOME_COLOR, AWAY_COLOR],
      plotOptions: {
        bar: {
          horizontal: true,
          barHeight: "60%"
        }
      },
      title: {
        text: "Match Stats",
        align: "center",
        style: { fontSize: "16px", fontFamily: "Inter", fontWeight: "700" }
      },
      legend: { position: "top" }
    }).render();

    /*************************************************************
     * 2) MOMENTUM CHART (Line Graph)
     *************************************************************/
    new ApexCharts(document.querySelector("#momentumChart"), {
      chart: {
        type: "line",
        height: "100%",
        width: "100%"
      },
      series: [
        { name: "Home Momentum", data: homeMomentumData },
        { name: "Away Momentum", data: awayMomentumData }
      ],
      xaxis: {
        categories: timeData,
        title: {
          text: "Time (minutes)",
          style: { fontFamily: "Inter", fontWeight: "700" }
        }
      },
      yaxis: {
        min: 0, max: 1,
        tickAmount: 2,  // 0, 0.5, 1
        labels: {
          formatter: (val) => val.toFixed(1),
          style: { fontFamily: "Inter", fontWeight: "700" }
        },
        title: {
          text: "Momentum",
          style: { fontFamily: "Inter", fontWeight: "700" }
        }
      },
      stroke: { width: 4 },
      colors: [HOME_COLOR, AWAY_COLOR],
      title: {
        text: "Momentum Over Time",
        align: "center",
        style: { fontSize: "16px", fontFamily: "Inter", fontWeight: "700" }
      },
      legend: { position: "top" }
    }).render();

    /*************************************************************
     * 3) BALL POSSESSION (Donut)
     *************************************************************/
    new ApexCharts(document.querySelector("#possessionChart"), {
      chart: {
        type: "donut",
        height: "100%",
        width: "100%"
      },
      series: [possessionHome, possessionAway],
      labels: ["Home", "Away"],
      colors: [HOME_COLOR, AWAY_COLOR],
      title: {
        text: "Ball Possession",
        align: "center",
        style: { fontSize: "16px", fontFamily: "Inter", fontWeight: "700" }
      },
      legend: { position: "bottom" }
    }).render();

    /*************************************************************
     * 4) TACTICAL HEATMAP (Attack vs. Defense Ratios)
     *************************************************************/
    new ApexCharts(document.querySelector("#zoneHeatmap"), {
      chart: {
        type: "heatmap",
        height: "100%",
        width: "100%"
      },
      series: zoneHeatmapSeries,
      plotOptions: {
        heatmap: {
          shadeIntensity: 0.8,
          colorScale: {
            // min=0 => away dominance, max=1 => home dominance
            min: 0,
            max: 1,
            inverse: false,
            // gradient from AWAY_COLOR (ratio=0) to HOME_COLOR (ratio=1)
            colors: [AWAY_COLOR, HOME_COLOR]
          }
        }
      },
      dataLabels: {
        enabled: true,
        style: { fontFamily: "Inter", fontWeight: "700", colors: ["#ffffff"] },
        formatter: (val) => val.toFixed(2)  // ratio with 2 decimals
      },
      xaxis: { type: "category" },
      title: {
        text: "Tactical Heatmap (Attack vs Defense)",
        align: "center",
        style: { fontSize: "16px", fontFamily: "Inter", fontWeight: "700" }
      },
      legend: { position: "top" }
    }).render();

  </script>
</body>
</html>
