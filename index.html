<!DOCTYPE html>
<html>
<head>
  <meta charset="utf-8">
  <title>Flashscore-Style Match Stats</title>
  <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
  <style>
    body {
      margin: 0;
      padding: 20px;
      font-family: Arial, sans-serif;
      background: #f8f8f8;
    }
    .chart-container {
      width: 100%;
      max-width: 900px;
      margin: auto;
    }
    /* Optional: control overall chart height so we have enough space
       for each row. Adjust as needed. */
    canvas {
      display: block;
      height: 600px; 
    }
  </style>
</head>
<body>
  <div class="chart-container">
    <canvas id="matchStatsChart"></canvas>
  </div>

  <script>
    /*************************************************************
     * 1) GET DATA FROM URL PARAMS
     *************************************************************/
    const params = new URLSearchParams(window.location.search);

    // Parse each param as a number (or 0 if missing)
    const homeShots         = Number(params.get("home_shots")         || 0);
    const awayShots         = Number(params.get("away_shots")         || 0);
    const homeShotsOnGoal   = Number(params.get("home_shots_on_goal") || 0);
    const awayShotsOnGoal   = Number(params.get("away_shots_on_goal") || 0);
    const homeGoalChances   = Number(params.get("home_goal_chances")  || 0);
    const awayGoalChances   = Number(params.get("away_goal_chances")  || 0);
    const homeDuelsWon      = Number(params.get("home_duels_won")     || 0);
    const awayDuelsWon      = Number(params.get("away_duels_won")     || 0);
    const homeSaves         = Number(params.get("home_saves")         || 0);
    const awaySaves         = Number(params.get("away_saves")         || 0);
    const homeCorners       = Number(params.get("home_corners")       || 0);
    const awayCorners       = Number(params.get("away_corners")       || 0);
    const homeFouls         = Number(params.get("home_fouls")         || 0);
    const awayFouls         = Number(params.get("away_fouls")         || 0);
    const homeYellows       = Number(params.get("home_yellows")       || 0);
    const awayYellows       = Number(params.get("away_yellows")       || 0);
    const homeReds          = Number(params.get("home_reds")          || 0);
    const awayReds          = Number(params.get("away_reds")          || 0);

    // Possession typically in percentages (e.g., 44 vs. 56)
    const possessionHome    = Number(params.get("PossessionHome")     || 0);
    const possessionAway    = Number(params.get("PossessionAway")     || 0);

    /*************************************************************
     * 2) BUILD LABELS & ARRAYS
     *************************************************************/
    // The order here matches the order of the data arrays
    const statLabels = [
      "Ball Possession",
      "Shots",
      "Shots on Goal",
      "Goal Chances",
      "Duels Won",
      "Saves",
      "Corners",
      "Fouls",
      "Yellows",
      "Reds"
    ];

    // Home & Away arrays in that same order
    const rawHomeData = [
      possessionHome,
      homeShots,
      homeShotsOnGoal,
      homeGoalChances,
      homeDuelsWon,
      homeSaves,
      homeCorners,
      homeFouls,
      homeYellows,
      homeReds
    ];

    const rawAwayData = [
      possessionAway,
      awayShots,
      awayShotsOnGoal,
      awayGoalChances,
      awayDuelsWon,
      awaySaves,
      awayCorners,
      awayFouls,
      awayYellows,
      awayReds
    ];

    /*************************************************************
     * 3) OPTIONAL: SCALE EACH ROW TO 100%
     *    If you want each row to be a "split bar" that sums to 100,
     *    we can do that here. If you prefer raw counts, skip this step.
     *************************************************************/
    function toPercentageArray(homeArr, awayArr) {
      return homeArr.map((homeVal, i) => {
        const awayVal = awayArr[i];
        const sum = homeVal + awayVal;
        if (sum > 0) {
          const homePct = (homeVal / sum) * 100;
          const awayPct = (awayVal / sum) * 100;
          return { home: homePct, away: awayPct };
        } else {
          return { home: 0, away: 0 };
        }
      });
    }

    // If you want purely *percentage-based* bars, do:
    const scaledStats = toPercentageArray(rawHomeData, rawAwayData);

    // Then separate them back into arrays for Chart.js
    const homeData = scaledStats.map(s => s.home);
    const awayData = scaledStats.map(s => s.away);

    // If you want to show *raw data*, skip the scaling step and use:
    //   const homeData = rawHomeData;
    //   const awayData = rawAwayData;
    // ...and remove or adjust the axis max below.

    /*************************************************************
     * 4) CUSTOM PLUGIN: LIGHT GRAY BACKGROUND BAR
     *    Draw a track from 0 to 100 behind each row.
     *************************************************************/
    const backgroundBarPlugin = {
      id: 'backgroundBar',
      beforeDatasetsDraw(chart) {
        const {
          ctx,
          chartArea: { top, bottom },
          scales: { x, y },
        } = chart;

        chart.data.labels.forEach((_, i) => {
          const yCenter = y.getPixelForValue(i);
          // Calculate bar height from center
          const barHeight = y.getPixelForValue(i - 0.5) - y.getPixelForValue(i + 0.5);
          const halfBar = Math.abs(barHeight / 2);

          // X-coords for 0% and 100%
          const x0 = x.getPixelForValue(0);
          const x100 = x.getPixelForValue(100);

          // Draw a light gray rectangle behind the bar
          ctx.save();
          ctx.fillStyle = '#e0e0e0';
          // Shrink the bar a bit vertically (0.6 factor)
          const rectTop = yCenter - halfBar * 0.6;
          const rectHeight = Math.abs(barHeight * 0.6);
          ctx.fillRect(x0, rectTop, x100 - x0, rectHeight);
          ctx.restore();
        });
      },
    };

    /*************************************************************
     * 5) CREATE THE CHART
     *************************************************************/
    const ctx = document.getElementById("matchStatsChart").getContext("2d");
    new Chart(ctx, {
      type: "bar",
      data: {
        labels: statLabels,
        datasets: [
          {
            label: "Home",
            data: homeData,
            backgroundColor: "#fa3048", // Flashscore pinkish-red
            borderRadius: 6,
          },
          {
            label: "Away",
            data: awayData,
            backgroundColor: "#2c2c2c", // Flashscore dark
            borderRadius: 6,
          }
        ]
      },
      options: {
        indexAxis: "y",
        responsive: true,
        maintainAspectRatio: false,
        scales: {
          x: {
            stacked: true,
            min: 0,
            max: 100, // Only relevant if scaling to 100
            grid: { display: false },
            ticks: {
              callback: val => val + "%"
            }
          },
          y: {
            stacked: true,
            grid: { display: false }
          }
        },
        plugins: {
          legend: {
            display: true,
            position: "top"
          },
          tooltip: {
            enabled: true,
            callbacks: {
              label: function(context) {
                // Show "Home: 45%" etc.
                const label = context.dataset.label || "";
                const val = context.parsed.x || 0;
                return label + ": " + val.toFixed(0) + "%";
              }
            }
          }
        }
      },
      plugins: [backgroundBarPlugin]
    });
  </script>
</body>
</html>
