<!DOCTYPE html>
<html>
<head>
  <meta charset="utf-8">
  <title>Stacked Horizontal Bars at 100% + Momentum Lines</title>
  <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;700&display=swap" rel="stylesheet">
  <style>
    body {
      margin: 0;
      padding: 20px;
      background: #f8f8f8;
      font-family: 'Inter', sans-serif;
      text-align: center;  /* center the canvases horizontally */
    }
    /* 
      We place each <canvas> directly in the <body>. 
      Each canvas can be up to 90% viewport width, max 900px,
      centered by margin: auto. No container div needed.
    */
    canvas {
      display: inline-block;
      width: 90vw;
      max-width: 900px;
      margin: 20px auto;
      background: #fff;
      border-radius: 8px;
      box-shadow: 0 1px 4px rgba(0,0,0,0.1);
    }
  </style>
</head>
<body>

  <!-- Stacked Horizontal 100%-Width Bars -->
  <canvas id="statsChart"></canvas>

  <!-- Momentum Line Chart -->
  <canvas id="momentumChart"></canvas>

  <script>
    /*************************************************************
     * 1) GLOBAL COLORS
     *************************************************************/
    const HOME_COLOR = "#fa3048";  // Pinkish red
    const AWAY_COLOR = "#2c2c2c";  // Dark gray

    /*************************************************************
     * 2) PARSE URL PARAMS
     *************************************************************/
    const params = new URLSearchParams(window.location.search);

    // A) Stats
    const homeShots         = Number(params.get("home_shots")         || 0);
    const awayShots         = Number(params.get("away_shots")         || 0);
    const homeShotsOnGoal   = Number(params.get("home_shots_on_goal") || 0);
    const awayShotsOnGoal   = Number(params.get("away_shots_on_goal") || 0);
    const homeGoalChances   = Number(params.get("home_goal_chances")  || 0);
    const awayGoalChances   = Number(params.get("away_goal_chances")  || 0);
    const homeDuelsWon      = Number(params.get("home_duels_won")     || 0);
    const awayDuelsWon      = Number(params.get("away_duels_won")     || 0);
    const homeSaves         = Number(params.get("home_saves")         || 0);
    const awaySaves         = Number(params.get("away_saves")         || 0);
    const homeCorners       = Number(params.get("home_corners")       || 0);
    const awayCorners       = Number(params.get("away_corners")       || 0);
    const homeFouls         = Number(params.get("home_fouls")         || 0);
    const awayFouls         = Number(params.get("away_fouls")         || 0);
    const homeYellows       = Number(params.get("home_yellows")       || 0);
    const awayYellows       = Number(params.get("away_yellows")       || 0);
    const homeReds          = Number(params.get("home_reds")          || 0);
    const awayReds          = Number(params.get("away_reds")          || 0);

    // e.g. 40 vs 60
    const possessionHome    = Number(params.get("possessionHome")     || 0);
    const possessionAway    = Number(params.get("possessionAway")     || 0);

    // B) Momentum
    const rawTimeTracker    = params.get("time_tracker")    || "0,15,30,45,60,75,90";
    const rawMomentum       = params.get("momentum_tracker")|| "0.5,0.55,0.6,0.55,0.4,0.7,0.6";

    const timeData          = rawTimeTracker.split(",").map(x => Number(x.trim()));
    const homeMomentumData  = rawMomentum.split(",").map(x => Number(x.trim()));
    const awayMomentumData  = homeMomentumData.map(v => 1 - v);

    /*************************************************************
     * 3) BUILD DATA ARRAYS FOR HORIZONTAL 100% BARS
     *    We'll scale each row so (Home + Away) = 100.
     *************************************************************/
    const statLabels = [
      "Ball Possession",
      "Shots",
      "Shots on Goal",
      "Goal Chances",
      "Duels Won",
      "Saves",
      "Corners",
      "Fouls",
      "Yellows",
      "Reds"
    ];
    const rawHomeValues = [
      possessionHome,
      homeShots,
      homeShotsOnGoal,
      homeGoalChances,
      homeDuelsWon,
      homeSaves,
      homeCorners,
      homeFouls,
      homeYellows,
      homeReds
    ];
    const rawAwayValues = [
      possessionAway,
      awayShots,
      awayShotsOnGoal,
      awayGoalChances,
      awayDuelsWon,
      awaySaves,
      awayCorners,
      awayFouls,
      awayYellows,
      awayReds
    ];

    // Convert each row to a total of 100
    const homePerc = [];
    const awayPerc = [];
    for (let i = 0; i < statLabels.length; i++) {
      const h = rawHomeValues[i];
      const a = rawAwayValues[i];
      const sum = h + a;
      if (sum === 0) {
        homePerc.push(0);
        awayPerc.push(0);
      } else {
        homePerc.push((h / sum) * 100);
        awayPerc.push((a / sum) * 100);
      }
    }

    /*************************************************************
     * 4) CUSTOM PLUGIN: PLACE LABEL ON TOP OF EACH ROW
     *************************************************************/
    const topLabelPlugin = {
      id: 'topLabelPlugin',
      afterDatasetsDraw(chart) {
        const { ctx, data, chartArea, scales } = chart;
        // indexAxis: 'y' means each label is a horizontal row
        // We'll place the label above each row.
        data.labels.forEach((label, i) => {
          // The y position for row i
          // scale 'y' because indexAxis: 'y'
          const yPos = scales.y.getPixelForValue(i);
          // The bar height is the distance between row i and row i+1
          let nextPos = scales.y.getPixelForValue(i + 1) || yPos + 30; 
          const half = (yPos + nextPos) / 2; // vertical center of row
          // We'll place text slightly above center (like a title)
          const textY = half - 10;

          ctx.save();
          ctx.textAlign = 'center';
          ctx.textBaseline = 'bottom';
          ctx.fillStyle = '#000';
          ctx.font = '700 14px Inter';
          ctx.fillText(label, chartArea.width / 2, textY);
          ctx.restore();
        });
      }
    };

    /*************************************************************
     * 5) BUILD THE STATS CHART CONFIG (STACKED HORIZONTAL BARS)
     *************************************************************/
    let delayed = false;
    const statsChartConfig = {
      type: 'bar',
      data: {
        labels: statLabels,
        datasets: [
          {
            label: "Home",
            data: homePerc,
            backgroundColor: HOME_COLOR
          },
          {
            label: "Away",
            data: awayPerc,
            backgroundColor: AWAY_COLOR
          }
        ]
      },
      options: {
        responsive: true,
        maintainAspectRatio: true,
        indexAxis: 'y',     // horizontal bars
        animation: {
          onComplete: () => { delayed = true; },
          delay: (ctx) => {
            let delay = 0;
            if (ctx.type === 'data' && ctx.mode === 'default' && !delayed) {
              delay = ctx.dataIndex * 300 + ctx.datasetIndex * 100;
            }
            return delay;
          }
        },
        scales: {
          x: {
            min: 0,
            max: 100, // each row sums to 100
            ticks: { display: false },
            grid: { display: false }
          },
          y: {
            // hide these so we only see bars
            ticks: { display: false },
            grid: { display: false }
          }
        },
        plugins: {
          legend: {
            display: true,
            position: 'top',
            labels: {
              font: {
                family: 'Inter',
                weight: '700'
              }
            }
          },
          tooltip: {
            titleFont: {
              family: 'Inter',
              weight: '700'
            },
            bodyFont: {
              family: 'Inter'
            },
            callbacks: {
              label: (context) => {
                // e.g., "Home: 45%"
                const label = context.dataset.label || "";
                const val   = context.parsed.x || 0;
                return `${label}: ${val.toFixed(1)}%`;
              }
            }
          }
        }
      },
      plugins: [ topLabelPlugin ]
    };
    // Build the stats chart
    new Chart(document.getElementById("statsChart"), statsChartConfig);

    /*************************************************************
     * 6) MOMENTUM LINE CHART: triple thickness, y up to 1.2
     *************************************************************/
    const momentumChartConfig = {
      type: 'line',
      data: {
        labels: timeData,
        datasets: [
          {
            label: "Home Momentum",
            data: homeMomentumData,
            borderColor: HOME_COLOR,
            borderWidth: 6, // triple thick
            radius: 0
          },
          {
            label: "Away Momentum",
            data: awayMomentumData,
            borderColor: AWAY_COLOR,
            borderWidth: 6,
            radius: 0
          }
        ]
      },
      options: {
        responsive: true,
        maintainAspectRatio: true,
        scales: {
          x: {
            type: 'linear',
            title: {
              display: true,
              text: "Time (minutes)",
              font: {
                family: 'Inter',
                weight: '700'
              }
            },
            ticks: {
              font: {
                family: 'Inter',
                weight: '700'
              }
            }
          },
          y: {
            min: 0,
            max: 1.2, // extra space above 1
            title: {
              display: true,
              text: "Momentum",
              font: {
                family: 'Inter',
                weight: '700'
              }
            },
            ticks: {
              font: {
                family: 'Inter',
                weight: '700'
              }
            }
          }
        },
        plugins: {
          legend: {
            display: true,
            position: 'top',
            labels: {
              font: {
                family: 'Inter',
                weight: '700'
              }
            }
          },
          tooltip: {
            mode: 'index',
            intersect: false,
            titleFont: {
              family: 'Inter',
              weight: '700'
            },
            bodyFont: {
              family: 'Inter'
            }
          }
        },
        interaction: {
          mode: 'index',
          intersect: false
        }
      }
    };
    // Build momentum chart
    new Chart(document.getElementById("momentumChart"), momentumChartConfig);
  </script>
</body>
</html>
