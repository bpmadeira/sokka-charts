<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="utf-8">
  <title>Match Stats & Momentum</title>
  <script src="https://cdn.jsdelivr.net/npm/apexcharts"></script>
  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;700&display=swap" rel="stylesheet">

  <style>
    html, body {
      overflow-y: auto; /* Allow vertical scrolling */
      margin: 0;
      padding: 0;
      font-family: "Inter", sans-serif;
      background: #f8f8f8;
      text-align: center;
      min-height: 100vh;
    }

    .chart-container {
      width: 90vw;
      max-width: 900px;
      margin: 30px auto;
      background: #fff;
      border-radius: 8px;
      padding: 20px 20px 30px 20px;
      box-shadow: 0 1px 4px rgba(0,0,0,0.1);
    }
    .chart-container:last-child {
      margin-bottom: 60px;
    }

    /* Possession Chart styling */
    #possessionChart {
      width: 100%;
      max-width: 400px;
      margin: auto;
      min-height: 400px;
    }

    /* Treemap containers */
    #treemapAttacking, #treemapDefending {
      width: 100%;
      height: 450px; /* Adjust as needed */
      margin: auto;
      min-width: 320px;
    }

  </style>
</head>
<body>

  <!-- 1) Two-Sided Bar Chart (Match Stats) -->
  <div class="chart-container">
    <div id="statsChart"></div>
  </div>

  <!-- 2) Momentum Chart -->
  <div class="chart-container">
    <div id="momentumChart"></div>
  </div>

  <!-- 3) Possession Chart -->
  <div class="chart-container">
    <div id="possessionChart"></div>
  </div>

  <!-- 4) Treemap Charts (Attacking & Defending) -->
  <div class="chart-container">
    <h2 style="margin-bottom: 10px;">Attacking Zones (Treemap)</h2>
    <div id="treemapAttacking"></div>
  </div>
  <div class="chart-container">
    <h2 style="margin-bottom: 10px;">Defending Zones (Treemap)</h2>
    <div id="treemapDefending"></div>
  </div>

  <script>
    /*************************************************************
     * 1) GLOBAL COLORS & PARSING
     *************************************************************/
    // We'll stay consistent with your existing scheme:
    // - RED / DARK GRAY for Home/Away in stats/momentum
    const HOME_COLOR = "#fa3048";
    const AWAY_COLOR = "#2c2c2c";

    // For the two-sided bar chart
    // (We reuse HOME_COLOR & AWAY_COLOR so itâ€™s consistent across all charts)
    const params = new URLSearchParams(window.location.search);

    function numParam(name, defaultVal = 0) {
      const val = params.get(name);
      return val ? Number(val) : defaultVal;
    }

    // 1) Parse Stats
    const homeStats = [
      numParam("home_shots"), 
      numParam("home_shots_on_goal"),
      numParam("home_goal_chances"), 
      numParam("home_duels_won"),
      numParam("home_saves"), 
      numParam("home_corners"),
      numParam("home_fouls"), 
      numParam("home_yellows"),
      numParam("home_reds")
    ];
    const awayStats = [
      numParam("away_shots"), 
      numParam("away_shots_on_goal"),
      numParam("away_goal_chances"), 
      numParam("away_duels_won"),
      numParam("away_saves"), 
      numParam("away_corners"),
      numParam("away_fouls"), 
      numParam("away_yellows"),
      numParam("away_reds")
    ];
    const statLabels = [
      "Shots", "Shots on Goal", "Goal Chances", "Duels Won",
      "Saves", "Corners", "Fouls", "Yellows", "Reds"
    ];

    // 2) Momentum
    const rawTimeTracker = params.get("time_tracker") || "0,15,30,45,60,75,90";
    const rawMomentum = params.get("momentum_tracker") || "0.5,0.55,0.6,0.55,0.4,0.7,0.6";
    const timeData = rawTimeTracker.split(",").map(x => +x.trim());
    const homeMomentumData = rawMomentum.split(",").map(x => +x.trim());
    const awayMomentumData = homeMomentumData.map(v => 1 - v);

    // 3) Possession
    const possessionHome = numParam("possessionHome", 50);
    const possessionAway = numParam("possessionAway", 50);

    // 4) Zone Strength for Treemap
    // We'll store attacking & defending for both home & away
    const homeAttack = [
      { x: "Buildup",   y: numParam("home_attack_buildup")   },
      { x: "Midfield",  y: numParam("home_attack_midfield")  },
      { x: "Wingplay",  y: numParam("home_attack_wingplay")  },
      { x: "Last Third",y: numParam("home_attack_lastthird") }
    ];
    const awayAttack = [
      { x: "Buildup",   y: numParam("away_attack_buildup")   },
      { x: "Midfield",  y: numParam("away_attack_midfield")  },
      { x: "Wingplay",  y: numParam("away_attack_wingplay")  },
      { x: "Last Third",y: numParam("away_attack_lastthird") }
    ];

    const homeDefend = [
      { x: "Buildup",   y: numParam("home_defend_buildup")   },
      { x: "Midfield",  y: numParam("home_defend_midfield")  },
      { x: "Wingplay",  y: numParam("home_defend_wingplay")  },
      { x: "Last Third",y: numParam("home_defend_lastthird") }
    ];
    const awayDefend = [
      { x: "Buildup",   y: numParam("away_defend_buildup")   },
      { x: "Midfield",  y: numParam("away_defend_midfield")  },
      { x: "Wingplay",  y: numParam("away_defend_wingplay")  },
      { x: "Last Third",y: numParam("away_defend_lastthird") }
    ];


    /*************************************************************
     * A) TWO-SIDED BAR CHART (Stats) with symmetrical X-axis
     *************************************************************/
    // Convert Home stats to negative for left-hand bars
    const homeStatsNeg = homeStats.map(val => -val);

    // Determine symmetrical min/max from absolute values
    const maxVal = Math.max(
      ...homeStats.map(Math.abs),
      ...awayStats.map(Math.abs)
    );

    new ApexCharts(document.querySelector("#statsChart"), {
      chart: { type: "bar", height: 400 },
      series: [
        { name: "Home", data: homeStatsNeg },
        { name: "Away", data: awayStats }
      ],
      xaxis: {
        categories: statLabels,
        labels: {
          formatter: (val) => Math.abs(val).toString()
        },
        min: -maxVal,
        max: maxVal
      },
      yaxis: {
        reversed: true
      },
      plotOptions: {
        bar: {
          horizontal: true,
          barHeight: "60%",
          dataLabels: { position: "center" }
        }
      },
      dataLabels: {
        enabled: true,
        formatter: (val) => Math.abs(val),
        style: {
          fontSize: "12px",
          fontFamily: "Inter",
          fontWeight: "700"
        }
      },
      colors: [HOME_COLOR, AWAY_COLOR],
      title: {
        text: "Match Stats",
        align: "center",
        style: { fontSize: "16px", fontFamily: "Inter", fontWeight: "700" }
      },
      legend: {
        position: "top"
      }
    }).render();


    /*************************************************************
     * B) MOMENTUM (Line Chart)
     *************************************************************/
    new ApexCharts(document.querySelector("#momentumChart"), {
      chart: {
        type: "line",
        height: 350,
        zoom: { enabled: false },
        toolbar: { show: false }
      },
      series: [
        { name: "Home Momentum", data: homeMomentumData },
        { name: "Away Momentum", data: awayMomentumData }
      ],
      xaxis: {
        categories: timeData,
        title: {
          text: "Time (minutes)",
          style: { fontFamily: "Inter", fontWeight: "700" }
        },
        tickAmount: 3,
        labels: {
          rotate: 0,
          style: { fontFamily: "Inter", fontWeight: "700" }
        }
      },
      yaxis: {
        min: 0, max: 1,
        tickAmount: 2,
        labels: {
          formatter: (val) => val.toFixed(1),
          style: { fontFamily: "Inter", fontWeight: "700" }
        },
        title: {
          text: "Momentum",
          style: { fontFamily: "Inter", fontWeight: "700" }
        }
      },
      stroke: { width: 4 },
      colors: [HOME_COLOR, AWAY_COLOR],
      title: {
        text: "Momentum Over Time",
        align: "center",
        style: { fontSize: "16px", fontFamily: "Inter", fontWeight: "700" }
      },
      legend: { position: "top" }
    }).render();


    /*************************************************************
     * C) POSSESSION (Donut Chart)
     *************************************************************/
    new ApexCharts(document.querySelector("#possessionChart"), {
      chart: { 
        type: "donut",
        height: 350,
        width: "100%"
      },
      series: [possessionHome, possessionAway],
      labels: ["Home", "Away"],
      colors: [HOME_COLOR, AWAY_COLOR],
      title: {
        text: "Ball Possession",
        align: "center",
        style: { fontSize: "16px", fontFamily: "Inter", fontWeight: "700" }
      },
      legend: {
        position: "bottom",
        offsetY: 10,
        fontSize: "14px",
        fontFamily: "Inter"
      },
      dataLabels: {
        style: {
          fontSize: "14px",
          fontFamily: "Inter",
          fontWeight: "bold"
        }
      },
      plotOptions: {
        pie: {
          donut: {
            size: "65%"
          },
          expandOnClick: false
        }
      },
      responsive: [{
        breakpoint: 480,
        options: {
          chart: { height: 300 }
        }
      }]
    }).render();


    /*************************************************************
     * D) TREEMAP CHARTS (Attacking & Defending)
     *
     * We'll create:
     *   - #treemapAttacking with 2 series: 
     *       1) "Home Attacking" -> homeAttack
     *       2) "Away Attacking" -> awayAttack
     *   - #treemapDefending with 2 series:
     *       1) "Home Defending" -> homeDefend
     *       2) "Away Defending" -> awayDefend
     *************************************************************/

    // 1) ATTACKING
    new ApexCharts(document.querySelector("#treemapAttacking"), {
      chart: {
        type: "treemap",
        height: "100%"
      },
      series: [
        {
          name: "Home Attacking",
          data: homeAttack // 4 rects: buildup, midfield, wingplay, last third
        },
        {
          name: "Away Attacking",
          data: awayAttack
        }
      ],
      title: {
        text: "Attacking Treemap",
        align: "center",
        style: { fontFamily: "Inter", fontWeight: "700", fontSize: "16px" }
      },
      legend: {
        position: "top",
        fontSize: "14px"
      },
      colors: [HOME_COLOR, AWAY_COLOR], 
      plotOptions: {
        treemap: {
          distributed: false, // each series has its own color
          enableShades: true,
          shadeIntensity: 0.4
        }
      },
      dataLabels: {
        enabled: true,
        style: {
          fontSize: "14px",
          fontFamily: "Inter",
          fontWeight: "700"
        },
        formatter: function(text, opt) {
          // text is the "x" (zone name),
          // opt.value is the "y" (numeric value)
          return text + "\n" + opt.value;
        }
      }
    }).render();

    // 2) DEFENDING
    new ApexCharts(document.querySelector("#treemapDefending"), {
      chart: {
        type: "treemap",
        height: "100%"
      },
      series: [
        {
          name: "Home Defending",
          data: homeDefend
        },
        {
          name: "Away Defending",
          data: awayDefend
        }
      ],
      title: {
        text: "Defending Treemap",
        align: "center",
        style: { fontFamily: "Inter", fontWeight: "700", fontSize: "16px" }
      },
      legend: {
        position: "top",
        fontSize: "14px"
      },
      colors: [HOME_COLOR, AWAY_COLOR],
      plotOptions: {
        treemap: {
          distributed: false,
          enableShades: true,
          shadeIntensity: 0.4
        }
      },
      dataLabels: {
        enabled: true,
        style: {
          fontSize: "14px",
          fontFamily: "Inter",
          fontWeight: "700"
        },
        formatter: function(text, opt) {
          return text + "\n" + opt.value;
        }
      }
    }).render();

    // A small timeout to ensure the layout flows properly
    setTimeout(() => {
      window.dispatchEvent(new Event("resize"));
    }, 100);

  </script>
</body>
</html>
